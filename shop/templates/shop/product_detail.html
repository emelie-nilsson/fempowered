{% extends "base.html" %}
{% load static %}
{% load currency %}
{% block content %}
<div class="product-detail">
  <h1 class="main-heading">{{ product.name }}</h1>

  <div class="product-grid">
    <!-- Image -->
    <figure class="product-media">
      <!-- Image logic: http, /static/, static/, /media/ . Fallback catalog_image_url and placeholder. -->
      {% with p=product.detail_image_url|default_if_none:'' %}
        {% if p and p|slice:":4" == "http" %}
          <img src="{{ p }}" alt="{{ product.name }}">
        {% elif p and p|slice:":8" == "/static/" %}
          <img src="{% static p|slice:'8:' %}" alt="{{ product.name }}">
        {% elif p and p|slice:":7" == "static/" %}
          <img src="{% static p|slice:'7:' %}" alt="{{ product.name }}">
        {% elif p and p|slice:":7" == "/media/" %}
          <img src="{% static p|slice:'7:' %}" alt="{{ product.name }}">
        {% elif p and p|first == "/" %}
          <img src="{% static p|slice:'1:' %}" alt="{{ product.name }}">
        {% elif p %}
          <img src="{% static p %}" alt="{{ product.name }}">
        {% elif product.catalog_image_url %}
          {% with c=product.catalog_image_url %}
            {% if c and c|slice:":4" == "http" %}
              <img src="{{ c }}" alt="{{ product.name }}">
            {% elif c and c|slice:":8" == "/static/" %}
              <img src="{% static c|slice:'8:' %}" alt="{{ product.name }}">
            {% elif c and c|slice:":7" == "static/" %}
              <img src="{% static c|slice:'7:' %}" alt="{{ product.name }}">
            {% elif c and c|slice:":7" == "/media/" %}
              <img src="{% static c|slice:'7:' %}" alt="{{ product.name }}">
            {% elif c and c|first == "/" %}
              <img src="{% static c|slice:'1:' %}" alt="{{ product.name }}">
            {% elif c %}
              <img src="{% static c %}" alt="{{ product.name }}">
            {% else %}
              <img src="{% static 'img/placeholder.webp' %}" alt="{{ product.name }}">
            {% endif %}
          {% endwith %}
        {% else %}
          <img src="{% static 'img/placeholder.webp' %}" alt="{{ product.name }}">
        {% endif %}
      {% endwith %}
    </figure>

    <!-- Description -->
    <section class="product-info">
      <h2 class="section-title">Description</h2>
      <p class="page-text">{{ product.description|linebreaks }}</p>

      {% if product.color %}
      <div class="product-color">
        Color: <strong>{{ product.color }}</strong>
      </div>
      {% endif %}

      <div class="product-price">{{ product.price }} €</div>

      <form class="product-actions" method="post" action="{% url 'cart_add' product.id %}">
        {% csrf_token %}
        {% if product.category == "Clothing" or product.category == "Clothes" %}
        <div class="form-row">
          <label for="id_size">Size</label>
          <select id="id_size" name="size">
            <option>XS</option>
            <option>S</option>
            <option>M</option>
            <option>L</option>
            <option>XL</option>
          </select>
        </div>
        {% endif %}
        <input type="hidden" name="quantity" value="1">
        <button type="submit" class="btn">Add to bag</button>
      </form>
    </section>

  {% if not user.is_authenticated %}
    <div class="account-nudge">
      <h2 class="h6 mb-2">
        <i class="fa-solid fa-user-check mr-2"></i> Aren’t you a part of Fempowered yet?
      </h2>
      <p class="mb-0">
        Create a free account to enjoy faster checkout, saved favorites and order tracking.  
        <a href="{% url 'account_signup' %}">Sign up</a> or
        <a href="{% url 'account_login' %}?next={{ request.path }}">Log in</a>.
      </p>
    </div>
  {% endif %}



    <!-- Reviews -->
    <section class="product-reviews">
      <h2 class="section-title">Reviews</h2>

      {% if reviews %}
        <ul class="review-list">
          {% for r in reviews %}
          <li class="review-item">
            <div class="review-meta">
              <strong>{{ r.user }}</strong>

              <!-- Star grade -->
              <div class="rating-static" aria-label="{{ r.rating }} out of 5">
                {% for _ in "12345"|make_list %}
                  <span class="star {% if forloop.counter <= r.rating %}on{% endif %}">★</span>
                {% endfor %}
              </div>

              {% if r.is_verified %}
                <span class="pill pill-verified"><span class="icon">✓</span> Verified buyer</span>
              {% endif %}
              <time class="review-date">{{ r.created_at|date:"Y-m-d H:i" }}</time>
            </div>

            {% if r.title %}<div class="mt-1"><em>{{ r.title }}</em></div>{% endif %}
            {% if r.body %}<div class="mt-1">{{ r.body }}</div>{% endif %}

            {% if request.user == r.user %}
            <div class="review-actions">
              <a href="{% url 'review_update' r.pk %}" class="btn">Edit</a>
              <form method="post" action="{% url 'review_delete' r.pk %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn" onclick="return confirm('Delete this review?')">Delete</button>
              </form>
            </div>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="page-text">No reviews yet.</p>
      {% endif %}
    </section>

    <!-- Write a review -->
    <section class="product-write-review">
      {% if can_review %}
        <h3 id="write-review" class="section-title">Write a review</h3>
        <form action="{% url 'review_create' product.pk %}" method="post" class="review-form">
          {% csrf_token %}

          <!-- Stars (1–5) -->
          <label for="star5" class="page-subtitle mb-1 d-block">Your rating</label>
          <div class="star-rating" role="radiogroup" aria-label="Set rating">
            <input type="radio" id="star5" name="rating" value="5" required><label for="star5" title="5 stars">★</label>
            <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars">★</label>
            <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars">★</label>
            <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars">★</label>
            <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star">★</label>
          </div>

          <div class="form-row mt-3">
            <label for="id_title">Title</label>
            {{ form.title }}
          </div>

          <div class="form-row">
            <label for="id_body">Review</label>
            {{ form.body }}
          </div>

          <button type="submit" class="btn">Publish</button>
        </form>

      {% elif not request.user.is_authenticated %}
        <h3 class="section-title">Write a review</h3>
        <p class="page-text"><a href="{% url 'account_login' %}?next={{ request.path }}">Log in</a> to write a review.</p>

      {% elif user_review %}
        <h3 class="section-title">Your review</h3>
        <p class="page-text">
          You have already reviewed this product.
          <a href="{% url 'review_update' user_review.pk %}">Edit your review</a>
        </p>

      {% else %}
        <h3 class="section-title">Write a review</h3>
        <p class="page-text">Only verified buyers can review this product.</p>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}
