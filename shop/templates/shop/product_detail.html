{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">

  <!-- Product content -->
  <div class="row">
    <!-- Left: product image -->
    <div class="col-md-6 mb-4">
      {% if product.image_detail %}
        <img src="{% static product.image_detail.name %}" class="img-fluid rounded shadow-sm" alt="{{ product.name }}" loading="lazy">
      {% elif product.image_catalog %}
        <img src="{% static product.image_catalog.name %}" class="img-fluid rounded shadow-sm" alt="{{ product.name }}" loading="lazy">
      {% else %}
        <div class="img-placeholder img-placeholder--portrait rounded shadow-sm"></div>
      {% endif %}
    </div>

    <!-- Right: product info and actions -->
    <div class="col-md-6">
      <h1 class="main-heading page-subtitle mb-2">{{ product.name }}</h1>

      {% if product.color %}
        <div class="mb-2 text-muted">Color: {{ product.color }}</div>
      {% endif %}

      <div class="h4 mb-3">{{ product.price }} €</div>

      {% if product.description %}
        <p class="lead">{{ product.description }}</p>
      {% endif %}

      <div class="actions">
        <form method="post" action="{% url 'add_to_cart' product.id %}">
          {% csrf_token %}
          <div class="form-row align-items-end">

            <!-- Show size selection only for Clothing/Clothes products (robust match) -->
            {% with cat=product.category|stringformat:"s"|lower %}
              {% if cat == "clothing" or cat == "clothes" %}
                <div class="col-auto mr-2">
                  <label for="size" class="form-label">Size</label>
                  <select id="size" name="size" class="custom-select" required>
                    <option value="" selected disabled>Select size</option>
                    <option value="XS">XS</option>
                    <option value="S">S</option>
                    <option value="M">M</option>
                    <option value="L">L</option>
                    <option value="XL">XL</option>
                  </select>
                </div>
              {% else %}
                <!-- Ensure backend always receives a size value for non-sized products -->
                <input type="hidden" name="size" value="NA">
              {% endif %}
            {% endwith %}

            <div class="col-auto mr-2">
              <label for="qty" class="form-label">Qty</label>
              <input id="qty" type="number" name="quantity" min="1" value="1" class="form-control" required>
            </div>
            <div class="col-auto">
              <button class="btn btn-fem">Add to cart</button>
            </div>
          </div>
        </form>

        <!-- Favorites: show real toggle only for authenticated users -->
        {% if request.user.is_authenticated %}
          <form method="post"
                action="{% url 'toggle_favorite' product.id %}?next={{ request.get_full_path|urlencode }}"
                class="fav-detail-form">
            {% csrf_token %}
            <button type="submit"
                    class="btn btn-fem fav-detail-btn"
                    aria-pressed="{{ is_favorite|yesno:'true,false' }}">
              <i class="fa-regular fa-heart mr-1 fav-icon not-fav"></i>
              <i class="fa-solid fa-heart mr-1 fav-icon is-fav"></i>
              <span data-add>Add to favorites</span>
              <span data-remove>Remove from favorites</span>
            </button>
          </form>
        {% else %}
          <!-- Anonymous users see a login CTA instead of a working favorite button -->
          <a class="btn btn-outline-secondary"
             href="{% url 'account_login' %}?next={{ request.get_full_path|urlencode }}">
            <i class="fa-regular fa-heart mr-1"></i> Log in to add to favorites
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Reviews -->
  <hr class="my-4">
  <h2 class="h5 page-subtitle mb-3">Reviews</h2>

  {% if reviews and reviews|length > 0 %}
    <ul class="list-unstyled">
      {% for r in reviews %}
        <li class="mb-3">

          <!-- Username + verified -->
          <div>
            <strong>{{ r.user }}</strong>
            {% if r.is_verified %}
              <span class="pill pill-verified">
                <i class="fa-solid fa-check icon"></i> Verified buyer
              </span>
            {% endif %}
          </div>

          <!-- Title -->
          {% if r.title %}
            <div class="mb-1"><strong>{{ r.title }}</strong></div>
          {% endif %}

          <!-- Stars -->
          {% with rate=r.rating|default:0 %}
            <div class="stars" aria-label="{{ rate }} out of 5">
              {% for i in "12345"|make_list %}
                <span class="star">{% if forloop.counter <= rate %}&#9733;{% else %}&#9734;{% endif %}</span>
              {% endfor %}
            </div>
          {% endwith %}

          <!-- Review body -->
          <div class="mt-1">{% firstof r.comment r.body r.text "" %}</div>

          {% if request.user.is_authenticated and r.user_id == request.user.id %}
            <div class="mt-1">
              <a class="btn btn-sm btn-fem" href="{% url 'review_update' r.pk %}">Edit</a>
              <form method="post" action="{% url 'review_delete' r.pk %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
              </form>
            </div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted mb-0">No reviews yet.</p>
  {% endif %}

  <!-- Write a review / login prompt + nudge -->
  {% if can_review and form %}
    <hr class="my-4">
    <h3 class="h6 page-subtitle">Write a review</h3>

    <form method="post" action="{% url 'review_create' pk=product.pk %}" class="review-form row g-3" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="col-12">
          <div class="alert alert-danger mb-2">
            {{ form.non_field_errors }}
          </div>
        </div>
      {% endif %}

      <!-- Title -->
      <div class="col-12">
        <label class="form-label" for="{{ form.title.id_for_label }}">Title</label>
        {{ form.title }}
        {% if form.title.errors %}
          <div class="invalid-feedback d-block">{{ form.title.errors|join:", " }}</div>
        {% endif %}
      </div>

      <!-- Rating -->
      <div class="col-12">
        {% with selected=form.rating.value %}
          <div class="stars" role="radiogroup" aria-label="Rating 1 to 5">
            <input type="radio" name="rating" id="star5" value="5" {% if selected == '5' %}checked{% endif %}>
            <label for="star5" title="5 stars" aria-label="5 stars">★</label>

            <input type="radio" name="rating" id="star4" value="4" {% if selected == '4' %}checked{% endif %}>
            <label for="star4" title="4 stars" aria-label="4 stars">★</label>

            <input type="radio" name="rating" id="star3" value="3" {% if selected == '3' %}checked{% endif %}>
            <label for="star3" title="3 stars" aria-label="3 stars">★</label>

            <input type="radio" name="rating" id="star2" value="2" {% if selected == '2' %}checked{% endif %}>
            <label for="star2" title="2 stars" aria-label="2 stars">★</label>

            <input type="radio" name="rating" id="star1" value="1" {% if selected == '1' %}checked{% endif %}>
            <label for="star1" title="1 star" aria-label="1 star">★</label>
          </div>
        {% endwith %}
        {% if form.rating.errors %}
          <div class="invalid-feedback d-block mt-1">{{ form.rating.errors|join:", " }}</div>
        {% endif %}
      </div>

      <!-- Body -->
      <div class="col-12">
        <label class="form-label" for="{{ form.body.id_for_label }}">Review</label>
        {{ form.body }}
        {% if form.body.errors %}
          <div class="invalid-feedback d-block">{{ form.body.errors|join:", " }}</div>
        {% endif %}
      </div>

      <!-- Submit -->
      <div class="col-12 review-submit">
        <button class="btn btn-fem">Submit</button>
      </div>
    </form>

  {% elif not request.user.is_authenticated %}
    <hr class="my-4">
    <p class="mb-2">
      <a class="btn btn-outline-secondary" href="{% url 'account_login' %}?next={{ request.get_full_path|urlencode }}">Log in</a>
      to write a review.
    </p>
    <div class="account-nudge">
      <h2 class="h6 mb-2">
        <i class="fa-solid fa-user-check mr-2"></i> Aren’t you a part of Fempowered yet?
      </h2>
      <p class="mb-0">
        Create a free account to enjoy faster checkout, saved favorites and order tracking.
        <a href="{% url 'account_signup' %}">Sign up</a> or
        <a href="{% url 'account_login' %}?next={{ request.get_full_path|urlencode }}">Log in</a>.
      </p>
    </div>

  {% elif has_reviewed %}
    <hr class="my-4">
    <p class="text-muted mb-0">You have already reviewed this product.</p>

  {% else %}
    <hr class="my-4">
    <p class="text-muted mb-0">Only verified buyers can write a review.</p>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
/* AJAX favorite toggle with instant UI feedback */
document.addEventListener("click", function(e){
  const btn = e.target.closest(".fav-detail-btn");
  if(!btn) return;
  e.preventDefault();

  const form = btn.closest(".fav-detail-form");
  const csrftoken = form.querySelector("input[name=csrfmiddlewaretoken]").value;

  fetch(form.action, {
    method: "POST",
    headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" }
  })
  .then(r => r.ok ? r.json() : Promise.reject())
  .then(() => {
    const pressed = btn.getAttribute("aria-pressed") === "true";
    btn.setAttribute("aria-pressed", (!pressed).toString());
  })
  .catch(() => form.submit());
});
</script>
{% endblock %}
