{% extends "base.html" %}
{% load static %}
{% load currency %}
{% block content %}
<div class="container py-5">
  <h1 class="main-heading">Checkout</h1>

  {% if order %}
  <div class="card mb-4">
    <div class="card-body d-flex justify-content-between">
      <div>
        <div><strong>{{ order.full_name }}</strong> — {{ order.email }}</div>
        <div>
          {{ order.address1 }}{% if order.address2 %}, {{ order.address2 }}{% endif %},
          {{ order.postal_code }} {{ order.city }}, {{ order.country }}
        </div>
        <div>Shipping: {{ order.get_shipping_method_display }}</div>
        <div class="mt-2">
          <a href="{% url 'checkout_address' %}" class="btn btn-link p-0">Change address/shipping</a>
        </div>
      </div>
      <div class="text-right">
        <div>Subtotal: <span id="subtotal-amount" data-cents="{{ order.subtotal }}"></span></div>
        <div>Shipping: <span id="shipping-amount" data-cents="{{ order.shipping_cost }}"></span></div>
        <h5 class="mt-2">Total: <span id="total-amount" data-cents="{{ order.total }}"></span></h5>
      </div>
    </div>
  </div>
  {% endif %}

  <form id="payment-form" class="mt-4" novalidate>
    {% csrf_token %}

    <label>Card details</label>
    <div id="card-element"></div>
    <div id="card-errors" class="text-danger mt-2" role="alert" aria-live="polite"></div>

    <!-- Server-provided client_secret -->
    
    <input type="hidden" name="client_secret" id="id_client_secret" value="{{ client_secret }}">

    <button id="pay-button" type="submit" class="btn btn-primary mt-3" disabled aria-disabled="true">
      Pay
    </button>
  </form>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const errorDiv = document.getElementById("card-errors");
  const form = document.getElementById("payment-form");
  const payBtn = document.getElementById("pay-button");
  const clientSecretInput = document.getElementById("id_client_secret");
  const clientSecret = clientSecretInput.value;

  //  Money formatting (EUR from cents) 
  function formatEUR(cents) {
    try { return new Intl.NumberFormat('sv-SE',{style:'currency',currency:'EUR'}).format((Number(cents)||0)/100); }
    catch(e) { return '€' + ((Number(cents)||0)/100).toFixed(2); }
  }
  function setMoneyText(id) {
    const el = document.getElementById(id);
    if (el) el.textContent = formatEUR(el.getAttribute('data-cents'));
  }
  setMoneyText('subtotal-amount');
  setMoneyText('shipping-amount');
  setMoneyText('total-amount');

  //  Helpers 
  function setLoading(isLoading) {
    payBtn.disabled = !!isLoading;
    payBtn.setAttribute("aria-disabled", isLoading ? "true" : "false");
    if (isLoading) {
      payBtn.dataset.label = payBtn.textContent;
      payBtn.textContent = "Processing…";
    } else {
      const totalEl = document.getElementById('total-amount');
      const totalTxt = totalEl ? totalEl.textContent : "";
      payBtn.textContent = payBtn.dataset.label || ("Pay " + (totalTxt || ""));
    }
  }
  function showError(msg) { errorDiv.textContent = msg || ""; }

  // Init Stripe
  const pk = "{{ STRIPE_PUBLISHABLE_KEY }}";
  if (!pk || !pk.startsWith("pk_")) {
    showError("Stripe publishable key missing. Check settings/.env.");
    return;
  }
  if (!clientSecret) {
    showError("Client secret missing. Reload the page.");
    return;
  }

  const stripe = Stripe(pk);
  const elements = stripe.elements();
  const card = elements.create("card");
  card.mount("#card-element");
  card.on("change", ev => showError(ev.error ? ev.error.message : ""));

  // CSRF cookie helper for fetch
  function getCookie(name) {
    const v = `; ${document.cookie}`;
    const p = v.split(`; ${name}=`);
    if (p.length === 2) return p.pop().split(';').shift();
  }
  const csrftoken = getCookie("csrftoken");

  // Enable pay button once ready
  setTimeout(() => { setLoading(false); }, 200);

  // Submit → confirm → confirm order on server
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (payBtn.disabled) return;
    showError("");
    setLoading(true);

    const { paymentIntent, error } = await stripe.confirmCardPayment(clientSecret, {
      payment_method: {
        card,
        {% if order %}
        billing_details: { name: "{{ order.full_name|escapejs }}", email: "{{ order.email|escapejs }}" }
        {% else %}
        billing_details: {}
        {% endif %}
      }
    });

    if (error) {
      showError(error.message || "Payment failed.");
      setLoading(false);
      return;
    }

    if (paymentIntent && paymentIntent.status === "succeeded") {
      try {
        const res = await fetch("{% url 'checkout_confirm' %}", {
          method: "POST",
          credentials: "same-origin",               
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest"
          },
          body: JSON.stringify({ payment_intent_id: paymentIntent.id })
        });

        // Read as text once, then try to parse JSON (avoids "body stream already read")
        const raw = await res.text();
        let data = null;
        try { data = raw ? JSON.parse(raw) : null; } catch(_) {}

        if (!res.ok) {
          const msg = (data && data.error) ? data.error : (raw || `HTTP ${res.status}`);
          throw new Error(msg);
        }

        if (data && data.ok && data.redirect_url) {
          window.location = data.redirect_url;
          return;
        }
        throw new Error((data && data.error) || "Could not confirm the order.");
      } catch (e) {
        showError((e && e.message) ? e.message : "Network error while confirming the order.");
      }
    } else {
      showError("Payment not completed.");
    }
    setLoading(false);
  });
});
</script>
{% endblock %}


